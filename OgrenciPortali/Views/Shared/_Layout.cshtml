@using System.Security.Claims
@using Roles = Shared.Enums.Roles
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Öğrenci Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>
<body>
<div id="app-wrapper">
    @Html.AntiForgeryToken()
    <aside id="sidebar">
        <div class="sidebar-header">
            <a href="@Url.Action("Index", "Home")" class="sidebar-brand">
                <i class="bi bi-mortarboard-fill"></i>
                <span>Öğrenci Portal</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <ul>
                @if (User.Identity.IsAuthenticated)
                {
                    <li>
                        <a href="@Url.Action("Index", "Home")">
                            <i class="bi bi-grid-1x2-fill"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>

                    if (User.IsInRole(nameof(Shared.Enums.Roles.Öğrenci)))
                    {
                        <li class="nav-section-title">
                            <span class="nav-text">Öğrenci İşlemleri</span>
                        </li>
                        <li>
                            <a href="@Url.Action("Enroll", "Student")">
                                <i class="bi bi-calendar2-check-fill"></i>
                                <span class="nav-text">Ders Seçimi</span>
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("MyCourses", "Student")">
                                <i class="bi bi-collection-fill"></i>
                                <span class="nav-text">Derslerim</span>
                            </a>
                        </li>
                    }

                    if (User.IsInRole(nameof(Shared.Enums.Roles.Danışman)))
                    {
                        <li class="nav-section-title">
                            <span class="nav-text">Danışman İşlemleri</span>
                        </li>
                        <li>
                            <a href="@Url.Action("CourseApprovals", "Advisor")">
                                <i class="bi bi-patch-check-fill"></i>
                                <span class="nav-text">Ders Onayları</span>
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("AdvisedStudentList", "Advisor")">
                                <i class="bi bi-people-fill"></i>
                                <span class="nav-text">Danışan Öğrenciler</span>
                            </a>
                        </li>
                    }

                    if (User.IsInRole(nameof(Shared.Enums.Roles.Admin)))
                    {
                        <li class="nav-section-title">
                            <span class="nav-text">Sistem Yönetimi</span>
                        </li>
                        <li class="has-submenu">
                            <a href="#">
                                <i class="bi bi-people-fill"></i>
                                <span class="nav-text">Kullanıcılar</span>
                                <i class="bi bi-chevron-down dropdown-arrow"></i>
                            </a>
                            <ul class="submenu">
                                <li>
                                    <a href="@Url.Action("List", "User")">
                                        <span class="nav-text">Kullanıcı Listesi</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="@Url.Action("Register", "User")">
                                        <span class="nav-text">Yeni Kullanıcı</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="has-submenu">
                            <a href="#">
                                <i class="bi bi-book-fill"></i>
                                <span class="nav-text">Dersler</span>
                                <i class="bi bi-chevron-down dropdown-arrow"></i>
                            </a>
                            <ul class="submenu">
                                <li>
                                    <a href="@Url.Action("List", "Courses")">
                                        <span class="nav-text">Ders Listesi</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="@Url.Action("List", "OfferedCourses")">
                                        <span class="nav-text">Açılan Dersler</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="@Url.Action("List", "Department")">
                                <i class="bi bi-building-fill"></i>
                                <span class="nav-text">Bölümler</span>
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("List", "Semester")">
                                <i class="bi bi-calendar-range-fill"></i>
                                <span class="nav-text">Dönemler</span>
                            </a>
                        </li>
                    }
                }
            </ul>
        </nav>
        <div class="sidebar-footer">
            @if (User.Identity.IsAuthenticated)
            {
                <a href="@Url.Action("Logout", "User")" class="logout-btn">
                    <i class="bi bi-box-arrow-left"></i>
                    <span class="nav-text">Çıkış Yap</span>
                </a>
            }
        </div>
    </aside>

    <!-- Rebuilt Main Content Area -->
    <div id="main-content">
        <!-- Rebuilt Navbar -->
        <header id="navbar">
            <div class="navbar-left">
                <button id="sidebar-toggle" class="sidebar-toggle-btn">
                    <i class="bi bi-list"></i>
                </button>
            </div>
            <div class="navbar-right">
                @if (User.Identity.IsAuthenticated)
                {
                    var claimsIdentity = User.Identity as ClaimsIdentity;
                    var userFullName = claimsIdentity?.FindFirst("full_name").Value;
                    var userEmail = claimsIdentity?.FindFirst("user_email")?.Value;

                    <div class="user-profile dropdown">
                        <button class="dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="user-info">
                                <span class="user-name">@userFullName</span>
                                <span class="user-role">@userEmail</span>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" href="@Url.Action("ChangePassword", "User")">
                                    <i class="bi bi-key-fill"></i> Şifre Değiştir
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="@Url.Action("Logout", "User")">
                                    <i class="bi bi-box-arrow-right"></i> Çıkış Yap
                                </a>
                            </li>
                        </ul>
                    </div>
                }
                else
                {
                    <a href="@Url.Action("Login", "User")" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Giriş Yap
                    </a>
                }
            </div>
        </header>

        <main class="container-fluid py-4">
            @RenderBody()
        </main>
    </div>
</div>

<!-- Modern Footer -->
<footer class="site-footer">
    <div class="footer-shape-divider">
        <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" class="shape-fill"></path>
        </svg>
    </div>

    <div class="container">
        <div class="row">

            <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
                <div class="footer-brand mb-4">
                    <i class="bi bi-mortarboard-fill brand-icon"></i>
                    <div class="brand-text">
                        <h5 class="mb-0">Öğrenci Portal</h5>
                        <span>Eğitim Yönetim Sistemi</span>
                    </div>
                </div>
                <p class="footer-text">
                    Modern teknoloji ile eğitim süreçlerinizi kolaylaştıran, öğrenci ve akademisyenler için entegre çözümler sunan kapsamlı platform.
                </p>
                <div class="social-icons mt-4">
                    <a href="#" title="Facebook">
                        <i class="bi bi-facebook"></i>
                    </a>
                    <a href="#" title="Twitter">
                        <i class="bi bi-twitter-x"></i>
                    </a>
                    <a href="#" title="Instagram">
                        <i class="bi bi-instagram"></i>
                    </a>
                    <a href="#" title="LinkedIn">
                        <i class="bi bi-linkedin"></i>
                    </a>
                    <a href="#" title="YouTube">
                        <i class="bi bi-youtube"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-2 col-md-6 mb-4 mb-lg-0">
                <h5 class="footer-heading">Hızlı Erişim</h5>
                <ul class="footer-links list-unstyled">
                    <li>
                        <a href="@Url.Action("Index", "Home")">Ana Sayfa</a>
                    </li>
                    @if (User.IsInRole(nameof(Roles.Öğrenci)))
                    {
                        <li>
                            <a href="@Url.Action("Enroll", "Student")">Ders Seçimi</a>
                        </li>
                        <li>
                            <a href="@Url.Action("MyCourses", "Student")">Derslerim</a>
                        </li>
                    }
                    @if (User.IsInRole(nameof(Roles.Danışman)))
                    {
                        <li>
                            <a href="@Url.Action("CourseApprovals", "Advisor")">Ders Onayları</a>
                        </li>
                    }
                    @if (User.IsInRole(nameof(Roles.Admin)))
                    {
                        <li>
                            <a href="@Url.Action("List", "User")">Kullanıcı Yönetimi</a>
                        </li>
                        <li>
                            <a href="@Url.Action("List", "Courses")">Ders Yönetimi</a>
                        </li>
                    }
                </ul>
            </div>

            <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                <h5 class="footer-heading">Destek</h5>
                <ul class="footer-links list-unstyled">
                    <li>
                        <a href="#" onclick="showFaqModal()">Sık Sorulan Sorular</a>
                    </li>
                    <li>
                        <a href="#" onclick="showHelpModal()">Yardım Merkezi</a>
                    </li>
                    <li>
                        <a href="#" onclick="showContactModal()">İletişime Geç</a>
                    </li>
                    <li>
                        <a href="@Url.Action("ChangePassword", "User")">Şifre İşlemleri</a>
                    </li>
                </ul>
            </div>

            <div class="col-lg-3 col-md-6">
                <h5 class="footer-heading">İletişim</h5>
                <ul class="contact-list list-unstyled">
                    <li>
                        <i class="bi bi-geo-alt-fill"></i>
                        <span>Küçükbakkalköy, Tevfik Fikret Cd. No:34, 34750 Ataşehir/İstanbul</span>
                    </li>
                    <li>
                        <i class="bi bi-telephone-fill"></i>
                        <a href="tel:+902125550123">+90 (212) 555 5555</a>
                    </li>
                    <li>
                        <i class="bi bi-envelope-fill"></i>
                        <a href="mailto:destek@alpeerkaraca.site">destek@alpeerkaraca.site</a>
                    </li>
                </ul>
            </div>

        </div>

        <div class="footer-bottom">
            <p class="copyright-text mb-0">&copy; @DateTime.Now.Year <strong>Öğrenci Portal</strong>. Tüm Hakları Saklıdır.</p>
            <div class="legal-links">
                <a href="#">Gizlilik Politikası</a>
                <span>&bull;</span>
                <a href="#">Kullanım Koşulları</a>
            </div>
        </div>
    </div>
</footer>
@Html.Partial("_FeedbackModal") 
@Styles.Render("~/Content/css")

@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/bootstrap")
@Scripts.Render("~/bundles/datatables")
@Scripts.Render("~/bundles/modernizr")
<script src="~/Scripts/js/app.js"></script>

<script>
    function dismissPasswordModal() {
        const modal = window.bootstrap.Modal.getInstance(document.getElementById('firstLoginModal'));
        if (modal) {
            modal.hide();
        }

        fetch('@Url.Action("DismissPasswordReminder", "User")',
            {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });
    }

// Footer Modal Functions
    function showHelpModal() {
        showFeedbackModal('info',
            'Yardım Merkezi',
            `<div class="text-start">
                     <h6><i class="bi bi-question-circle me-2"></i>Nasıl yardım alabilirim?</h6>
                     <ul class="list-unstyled">
                         <li class="mb-2"><i class="bi bi-arrow-right me-2 text-primary"></i>Sistem yöneticiniz ile iletişime geçin</li>
                         <li class="mb-2"><i class="bi bi-arrow-right me-2 text-primary"></i>E-posta: info@ogrenciportal.edu.tr</li>
                         <li class="mb-2"><i class="bi bi-arrow-right me-2 text-primary"></i>Telefon: +90 (212) 555-0123</li>
                         <li class="mb-2"><i class="bi bi-arrow-right me-2 text-primary"></i>Çalışma Saatleri: Pzt-Cum 08:00-17:00</li>
                     </ul>
                 </div>`);
    }

    function showContactModal() {
        showFeedbackModal('info',
            'İletişim Bilgileri',
            `<div class="text-start">
                     <div class="contact-info-modal">
                         <div class="mb-3">
                             <h6><i class="bi bi-building me-2 text-primary"></i>Eğitim Teknolojileri Merkezi</h6>
                             <p class="text-muted mb-1">Öğrenci Portal Yönetim Sistemi</p>
                         </div>
                         <div class="mb-3">
                             <h6><i class="bi bi-envelope me-2 text-primary"></i>E-posta</h6>
                             <p class="text-muted mb-1">info@ogrenciportal.edu.tr</p>
                             <p class="text-muted mb-1">destek@ogrenciportal.edu.tr</p>
                         </div>
                         <div class="mb-3">
                             <h6><i class="bi bi-telephone me-2 text-primary"></i>Telefon</h6>
                             <p class="text-muted mb-1">+90 (212) 555-0123</p>
                             <p class="text-muted mb-1">+90 (212) 555-0124 (Teknik Destek)</p>
                         </div>
                         <div class="mb-3">
                             <h6><i class="bi bi-clock me-2 text-primary"></i>Çalışma Saatleri</h6>
                             <p class="text-muted mb-1">Pazartesi - Cuma: 08:00 - 17:00</p>
                             <p class="text-muted mb-1">Cumartesi: 09:00 - 13:00</p>
                             <p class="text-muted">Pazar: Kapalı</p>
                         </div>
                     </div>
                 </div>`);
    }

    function showFaqModal() {
        showFeedbackModal('info',
            'Sık Sorulan Sorular',
            `<div class="text-start">
                     <div class="accordion" id="faqAccordion">
                         <div class="accordion-item">
                             <h2 class="accordion-header">
                                 <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                     <i class="bi bi-question-circle me-2"></i>Şifremi unuttum, ne yapmalıyım?
                                 </button>
                             </h2>
                             <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                 <div class="accordion-body">
                                     Sistem yöneticiniz ile iletişime geçerek yeni şifre talebinde bulunabilirsiniz.
                                 </div>
                             </div>
                         </div>
                         <div class="accordion-item">
                             <h2 class="accordion-header">
                                 <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                     <i class="bi bi-question-circle me-2"></i>Ders seçimi nasıl yapılır?
                                 </button>
                             </h2>
                             <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                 <div class="accordion-body">
                                     Öğrenci panelinden "Ders Seçimi" bölümüne giderek istediğiniz dersleri seçebilirsiniz.
                                 </div>
                             </div>
                         </div>
                         <div class="accordion-item">
                             <h2 class="accordion-header">
                                 <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                     <i class="bi bi-question-circle me-2"></i>Sistem ne zaman güncellenir?
                                 </button>
                             </h2>
                             <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                 <div class="accordion-body">
                                     Sistem güncellemeleri genellikle hafta sonları yapılır ve kullanıcılar önceden bilgilendirilir.
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>`);
    }

    document.addEventListener('DOMContentLoaded',
        function() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click',
                    function(e) {
                        e.preventDefault();
                        if (window.innerWidth > 1200) {
                            // Desktop: collapse/expand sidebar width
                            sidebar.classList.toggle('collapsed');
                            if (mainContent) {
                                mainContent.classList.toggle('sidebar-collapsed');
                            }
                        } else {
                            // Mobile: slide sidebar in/out
                            sidebar.classList.toggle('show');
                        }
                    });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click',
                function(event) {
                    if (window.innerWidth <= 1200) {
                        const isClickInsideSidebar = sidebar && sidebar.contains(event.target);
                        const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target);

                        if (!isClickInsideSidebar && !isClickOnToggler && sidebar && sidebar.classList.contains('show')) {
                            sidebar.classList.remove('show');
                        }
                    }
                });

            // Handle window resize
            window.addEventListener('resize',
                function() {
                    if (window.innerWidth > 1200 && sidebar && sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                    }
                });

            // Initialize Bootstrap dropdowns
            if (typeof bootstrap !== 'undefined') {
                var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
                var dropdownList = dropdownElementList.map(function(dropdownToggleEl) {
                    return new bootstrap.Dropdown(dropdownToggleEl);
                });
            }
        });

    document.addEventListener('DOMContentLoaded',
        function() {
            @if (User.Identity.IsAuthenticated)
            {
                var claimsIdentity = User.Identity as ClaimsIdentity;
                var userIsFirstLogin = claimsIdentity?.FindFirst("first_login").Value;

                <text>
                    if (@Html.Raw(string.IsNullOrEmpty(userIsFirstLogin)).ToString().ToLower() && (@Html.Raw(userIsFirstLogin != null && userIsFirstLogin.ToLower() == "true").ToString().ToLower() && @(Session["PasswordChangeModalShown"] == null ? "true" : "false"))) {
                        const firstLoginModal = new window.bootstrap.Modal(document.getElementById('firstLoginModal'));
                        firstLoginModal.show();

                        document.getElementById('firstLoginModal').addEventListener('hidden.bs.modal',
                            function() {
                                fetch('@Url.Action("MarkPasswordModalShown", "User")',
                                    {
                                        method: 'POST',
                                        headers: {
                                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                                        }
                                    });
                            });
                    }
                </text>
            }
        });
</script>
@Scripts.Render("~/bundles/modernizr")
<script src="~/Scripts/js/app.js"></script>

<script>
    document.addEventListener('DOMContentLoaded',
        function() {
            const sidebar = document.getElementById('sidebar');

            // --- SIDEBAR SUBMENU ACCORDION ---
            const submenuToggles = document.querySelectorAll('#sidebar .has-submenu > a');
            submenuToggles.forEach(function(toggle) {
                toggle.addEventListener('click',
                    function(e) {
                        // Prevent link navigation
                        e.preventDefault();

                        // Don't run accordion logic if sidebar is collapsed (it uses hover instead)
                        if (sidebar.classList.contains('collapsed')) {
                            return;
                        }

                        const parentLi = this.parentElement;
                        const submenu = this.nextElementSibling;

                        // Close other open submenus to create an accordion effect
                        document.querySelectorAll('#sidebar .has-submenu.open').forEach(function(openSubmenu) {
                            if (openSubmenu !== parentLi) {
                                openSubmenu.classList.remove('open');
                                openSubmenu.querySelector('.submenu').style.maxHeight = null;
                            }
                        });

                        // Toggle the current submenu
                        parentLi.classList.toggle('open');
                        if (parentLi.classList.contains('open')) {
                            // Set max-height to its scrollHeight to animate opening
                            submenu.style.maxHeight = submenu.scrollHeight + "px";
                        } else {
                            // Set max-height to null to animate closing
                            submenu.style.maxHeight = null;
                        }
                    });
            });
        });
</script>

@*<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.js"></script>*@


@RenderSection("scripts", required: false)
</body>
</html>